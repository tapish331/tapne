{% extends "base.html" %}

{% block title %}tapne | Reviews{% endblock %}

{% block content %}
<section class="hero hero-compact">
    <p class="eyebrow">Reviews</p>
    <h1>{{ review_target_label|default:"Target reviews" }}</h1>
    <p class="detail-meta">{{ review_reason|default:"Member reviews and ratings for this page." }}</p>
    <p class="detail-meta">Average rating: {{ review_average_rating|floatformat:1 }}/5 from {{ review_count }} review{{ review_count|pluralize }}</p>

    <div class="inline-actions">
        <a class="btn btn-secondary" href="{{ review_target_url|default:'/' }}">Back to target</a>
    </div>
</section>

<section class="detail-shell">
    <h2>Distribution</h2>
    <dl class="card-meta-grid">
        {% for bucket in review_rating_buckets %}
        <div>
            <dt>{{ bucket.rating }}/5</dt>
            <dd>{{ bucket.count }}</dd>
        </div>
        {% endfor %}
    </dl>
</section>

<section id="media" class="detail-shell stack-gap-top">
    <h2>Target media</h2>
    <p class="detail-meta">{{ target_media_reason|default:"Media attached to this page and its reviews." }}</p>

    {% if target_media_can_upload %}
    <form method="post" action="{% url 'media:upload' %}" enctype="multipart/form-data" class="search-form">
        {% csrf_token %}
        <input type="hidden" name="target_type" value="{{ review_target_type }}">
        <input type="hidden" name="target_id" value="{{ review_target_key }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}#media">

        <label for="target-media-file">Upload media</label>
        <input id="target-media-file" class="form-input" type="file" name="file" accept="image/*,video/*" required>

        <label for="target-media-caption">Caption (optional)</label>
        <input id="target-media-caption" class="form-input" type="text" name="caption" maxlength="280" placeholder="Add context for this media item.">

        <button class="btn btn-primary" type="submit">Upload</button>
    </form>
    {% elif user.is_authenticated %}
    <p class="muted-inline">Only the target owner can upload media here.</p>
    {% else %}
    <button class="btn btn-primary js-guest-action" type="button" data-action-label="upload media">Log in to upload media</button>
    {% endif %}

    {% if target_media_items %}
    <div class="media-grid">
        {% for item in target_media_items %}
        <article class="card media-card">
            {% if item.kind == "image" %}
            <img class="media-preview-image" src="{{ item.file_url }}" alt="{{ item.caption|default:item.filename }}">
            {% else %}
            <video class="media-preview-video" controls preload="metadata">
                <source src="{{ item.file_url }}" type="{{ item.content_type }}">
            </video>
            {% endif %}

            {% if item.caption %}
            <p class="card-description">{{ item.caption }}</p>
            {% endif %}
            <p class="card-subtitle">{{ item.size_label }} 路 {{ item.content_type|default:item.kind }}</p>

            <div class="inline-actions">
                <a class="btn btn-secondary" href="{{ item.file_url }}" target="_blank" rel="noopener">Open</a>
                {% if item.can_manage %}
                <form method="post" action="{% url 'media:delete' attachment_id=item.id %}" class="inline-form media-delete-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}#media">
                    <button class="btn btn-ghost" type="submit">Delete</button>
                </form>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No media uploaded for this target yet.</p>
    {% endif %}
</section>

<section id="write-review" class="detail-shell stack-gap-top">
    <h2>Write a review</h2>
    {% if user.is_authenticated and review_can_review %}
    <form method="post" action="{% url 'reviews:create' %}" class="search-form">
        {% csrf_token %}
        <input type="hidden" name="target_type" value="{{ review_target_type }}">
        <input type="hidden" name="target_id" value="{{ review_target_key }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}">

        <label for="review-rating">Rating</label>
        <select id="review-rating" class="form-input" name="rating">
            <option value="5">5 - Excellent</option>
            <option value="4">4 - Strong</option>
            <option value="3">3 - Solid</option>
            <option value="2">2 - Needs work</option>
            <option value="1">1 - Poor</option>
        </select>

        <label for="review-headline">Headline (optional)</label>
        <input id="review-headline" class="form-input" type="text" name="headline" maxlength="160" placeholder="Summarize your experience in one line.">

        <label for="review-body">Your review</label>
        <input id="review-body" class="form-input" type="text" name="body" maxlength="4000" placeholder="What stood out? What should improve?">

        <button class="btn btn-primary" type="submit">
            {% if review_viewer_row %}Update review{% else %}Post review{% endif %}
        </button>
    </form>
    {% else %}
    <button class="btn btn-primary js-guest-action" type="button" data-action-label="write a review">Log in to review</button>
    {% endif %}
</section>

<section class="detail-shell stack-gap-top">
    <h2>Recent reviews</h2>
    {% if review_items %}
    <div class="comments-stack">
        {% for item in review_items %}
        <article class="card comment-item">
            <p class="card-subtitle">
                @{{ item.author_username }} 路 {{ item.created_at|date:"M j, Y H:i" }} 路 {{ item.rating }}/5
                {% if item.is_mine %} 路 Your review{% endif %}
            </p>
            {% if item.headline %}
            <p><strong>{{ item.headline }}</strong></p>
            {% endif %}
            <p class="card-description">{{ item.body }}</p>

            {% if item.media_attachments %}
            <div class="media-inline-list">
                {% for media_item in item.media_attachments %}
                <div class="media-inline-item">
                    <span class="media-pill">{{ media_item.kind|title }}</span>
                    <a href="{{ media_item.file_url }}" target="_blank" rel="noopener">{{ media_item.filename }}</a>
                    <span class="muted-inline">{{ media_item.size_label }}</span>
                    {% if media_item.can_manage %}
                    <form method="post" action="{% url 'media:delete' attachment_id=media_item.id %}" class="inline-form media-delete-form">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button class="btn btn-ghost" type="submit">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if user.is_authenticated and item.is_mine %}
            <form method="post" action="{% url 'media:upload' %}" enctype="multipart/form-data" class="media-form-inline">
                {% csrf_token %}
                <input type="hidden" name="target_type" value="review">
                <input type="hidden" name="target_id" value="{{ item.id }}">
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <label for="review-media-list-{{ item.id }}">Attach media to this review</label>
                <input id="review-media-list-{{ item.id }}" class="form-input" type="file" name="file" accept="image/*,video/*" required>
                <input class="form-input" type="text" name="caption" maxlength="280" placeholder="Optional caption">
                <button class="btn btn-ghost" type="submit">Attach media</button>
            </form>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No reviews yet. Members can add the first review.</p>
    {% endif %}
</section>
{% endblock %}
