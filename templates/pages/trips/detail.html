{% extends "base.html" %}

{% block title %}tapne | Trip Details{% endblock %}

{% block content %}
<article class="detail-shell">
    <p class="eyebrow">Trip details</p>
    <h1>{{ trip.title|default:"Trip title" }}</h1>

    {% if trip_detail_reason %}
    <p class="detail-meta">{{ trip_detail_reason }} ({{ trip_detail_mode|default:"unknown" }} / {{ trip_detail_source|default:"unknown" }})</p>
    {% endif %}

    <p class="detail-meta">
        Host:
        {% if trip.host_username %}
        <a href="/u/{{ trip.host_username }}/">@{{ trip.host_username }}</a>
        {% else %}
        @host
        {% endif %}
    </p>

    {% if trip.destination %}
    <p class="detail-meta">Destination: {{ trip.destination }}</p>
    {% endif %}

    <p>{{ trip.description|default:"Trip description is not available yet." }}</p>

    <div class="inline-actions">
        {% if can_manage_trip %}
        <a class="btn btn-secondary" href="/trips/{{ trip.id }}/edit/">Edit trip</a>
        <a class="btn btn-primary" href="{% url 'enrollment:hosting-inbox' %}">Hosting inbox</a>
        <form method="post" action="/trips/{{ trip.id }}/delete/" class="inline-form">
            {% csrf_token %}
            <button class="btn btn-ghost" type="submit">Delete trip</button>
        </form>
        {% elif user.is_authenticated %}
        <form method="post" action="{% url 'enrollment:trip-request' trip_id=trip.id %}" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-primary" type="submit">Request to join</button>
        </form>
        <form method="post" action="{% url 'social:bookmark' %}" class="inline-form">
            {% csrf_token %}
            <input type="hidden" name="type" value="trip">
            <input type="hidden" name="id" value="{{ trip.id }}">
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="btn btn-ghost" type="submit">Bookmark</button>
        </form>
        <a class="btn btn-secondary" href="#comments">Comment</a>
        <a class="btn btn-secondary" href="#reviews">Review</a>
        {% else %}
        <button class="btn btn-primary js-guest-action" type="button" data-action-label="join this trip">Request to join</button>
        <button class="btn btn-ghost js-guest-action" type="button" data-action-label="bookmark this trip">Bookmark</button>
        <button class="btn btn-secondary js-guest-action" type="button" data-action-label="comment on this trip">Comment</button>
        <button class="btn btn-secondary js-guest-action" type="button" data-action-label="review this trip">Review</button>
        {% endif %}
    </div>
</article>

<section id="media" class="detail-shell stack-gap-top">
    <p class="eyebrow">Trip media</p>
    <h2>Photos and videos</h2>
    <p class="detail-meta">{{ trip_media_reason }} ({{ trip_media_mode|default:"unknown" }})</p>

    {% if trip_media_can_upload %}
    <form method="post" action="{% url 'media:upload' %}" enctype="multipart/form-data" class="search-form">
        {% csrf_token %}
        <input type="hidden" name="target_type" value="trip">
        <input type="hidden" name="target_id" value="{{ trip.id }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}#media">

        <label for="trip-media-file">Upload media</label>
        <input id="trip-media-file" class="form-input" type="file" name="file" accept="image/*,video/*" required>

        <label for="trip-media-caption">Caption (optional)</label>
        <input id="trip-media-caption" class="form-input" type="text" name="caption" maxlength="280" placeholder="Add context for this media item.">

        <button class="btn btn-primary" type="submit">Upload</button>
    </form>
    {% elif user.is_authenticated %}
    <p class="muted-inline">Only the host can upload media for this trip.</p>
    {% else %}
    <button class="btn btn-primary js-guest-action" type="button" data-action-label="upload trip media">Log in to upload media</button>
    {% endif %}

    {% if trip_media_items %}
    <div class="media-grid">
        {% for item in trip_media_items %}
        <article class="card media-card">
            {% if item.kind == "image" %}
            <img class="media-preview-image" src="{{ item.file_url }}" alt="{{ item.caption|default:item.filename }}">
            {% else %}
            <video class="media-preview-video" controls preload="metadata">
                <source src="{{ item.file_url }}" type="{{ item.content_type }}">
            </video>
            {% endif %}

            {% if item.caption %}
            <p class="card-description">{{ item.caption }}</p>
            {% endif %}
            <p class="card-subtitle">{{ item.size_label }} · {{ item.content_type|default:item.kind }}</p>

            <div class="inline-actions">
                <a class="btn btn-secondary" href="{{ item.file_url }}" target="_blank" rel="noopener">Open</a>
                {% if item.can_manage %}
                <form method="post" action="{% url 'media:delete' attachment_id=item.id %}" class="inline-form media-delete-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}#media">
                    <button class="btn btn-ghost" type="submit">Delete</button>
                </form>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No media uploaded for this trip yet.</p>
    {% endif %}
</section>

<section id="comments" class="detail-shell stack-gap-top">
    <p class="eyebrow">Trip comments</p>
    <h2>Conversation</h2>
    <p class="detail-meta">{{ interaction_comment_reason }} ({{ interaction_comment_mode|default:"unknown" }})</p>

    {% if user.is_authenticated %}
    <form method="post" action="{% url 'interactions:comment' %}" class="search-form">
        {% csrf_token %}
        <input type="hidden" name="target_type" value="trip">
        <input type="hidden" name="target_id" value="{{ trip.id }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}#comments">
        <label for="trip-comment-text">Add a comment</label>
        <input id="trip-comment-text" class="form-input" type="text" name="text" maxlength="2000" placeholder="Share your question or note for this trip.">
        <button class="btn btn-primary" type="submit">Post comment</button>
    </form>
    {% else %}
    <button class="btn btn-primary js-guest-action" type="button" data-action-label="comment on this trip">Log in to comment</button>
    {% endif %}

    {% if interaction_comments %}
    <div class="comments-stack">
        {% for item in interaction_comments %}
        <article class="card comment-item">
            <p class="card-subtitle">@{{ item.author_username }} · {{ item.created_at|date:"M j, Y H:i" }}</p>
            <p class="card-description">{{ item.text }}</p>

            {% if item.replies %}
            <div class="reply-stack">
                {% for reply in item.replies %}
                <div class="card">
                    <p class="card-subtitle">@{{ reply.author_username }} · {{ reply.created_at|date:"M j, Y H:i" }}</p>
                    <p class="card-description">{{ reply.text }}</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if user.is_authenticated %}
            <form method="post" action="{% url 'interactions:reply' %}" class="search-form">
                {% csrf_token %}
                <input type="hidden" name="comment_id" value="{{ item.id }}">
                <input type="hidden" name="next" value="{{ request.get_full_path }}#comments">
                <label for="reply-trip-{{ item.id }}">Reply to @{{ item.author_username }}</label>
                <input id="reply-trip-{{ item.id }}" class="form-input" type="text" name="text" maxlength="2000" placeholder="Write a reply.">
                <button class="btn btn-ghost" type="submit">Reply</button>
            </form>
            {% else %}
            <button class="btn btn-ghost js-guest-action" type="button" data-action-label="reply to this comment">Reply</button>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No comments yet. Be the first to leave a note.</p>
    {% endif %}
</section>

<section id="reviews" class="detail-shell stack-gap-top">
    <p class="eyebrow">Trip reviews</p>
    <h2>Ratings</h2>
    <p class="detail-meta">{{ review_reason }} ({{ review_mode|default:"unknown" }})</p>
    <p class="detail-meta">Average rating: {{ review_average_rating|floatformat:1 }}/5 from {{ review_count }} review{{ review_count|pluralize }}</p>

    {% if review_rating_buckets %}
    <dl class="card-meta-grid">
        {% for bucket in review_rating_buckets %}
        <div>
            <dt>{{ bucket.rating }}/5</dt>
            <dd>{{ bucket.count }}</dd>
        </div>
        {% endfor %}
    </dl>
    {% endif %}

    {% if user.is_authenticated %}
    <form method="post" action="{% url 'reviews:create' %}" class="search-form">
        {% csrf_token %}
        <input type="hidden" name="target_type" value="trip">
        <input type="hidden" name="target_id" value="{{ trip.id }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}#reviews">

        <label for="trip-review-rating">Rating</label>
        <select id="trip-review-rating" class="form-input" name="rating">
            <option value="5">5 - Excellent</option>
            <option value="4">4 - Strong</option>
            <option value="3">3 - Solid</option>
            <option value="2">2 - Needs work</option>
            <option value="1">1 - Poor</option>
        </select>

        <label for="trip-review-headline">Headline (optional)</label>
        <input id="trip-review-headline" class="form-input" type="text" name="headline" maxlength="160" placeholder="Summarize your experience in one line.">

        <label for="trip-review-body">Your review</label>
        <input id="trip-review-body" class="form-input" type="text" name="body" maxlength="4000" placeholder="What worked well, what should improve?">

        <div class="inline-actions">
            <button class="btn btn-primary" type="submit">
                {% if review_viewer_row %}Update review{% else %}Post review{% endif %}
            </button>
            <a class="btn btn-ghost" href="{% url 'reviews:target-list' target_type='trip' target_id=trip.id %}">Open full reviews page</a>
        </div>
    </form>
    {% else %}
    <div class="inline-actions">
        <button class="btn btn-primary js-guest-action" type="button" data-action-label="review this trip">Log in to review</button>
        <a class="btn btn-secondary" href="{% url 'reviews:target-list' target_type='trip' target_id=trip.id %}">Browse all reviews</a>
    </div>
    {% endif %}

    {% if review_items %}
    <div class="comments-stack">
        {% for item in review_items %}
        <article class="card comment-item">
            <p class="card-subtitle">
                @{{ item.author_username }} · {{ item.created_at|date:"M j, Y H:i" }} · {{ item.rating }}/5
                {% if item.is_mine %} · Your review{% endif %}
            </p>
            {% if item.headline %}
            <p><strong>{{ item.headline }}</strong></p>
            {% endif %}
            <p class="card-description">{{ item.body }}</p>

            {% if item.media_attachments %}
            <div class="media-inline-list">
                {% for media_item in item.media_attachments %}
                <div class="media-inline-item">
                    <span class="media-pill">{{ media_item.kind|title }}</span>
                    <a href="{{ media_item.file_url }}" target="_blank" rel="noopener">{{ media_item.filename }}</a>
                    <span class="muted-inline">{{ media_item.size_label }}</span>
                    {% if media_item.can_manage %}
                    <form method="post" action="{% url 'media:delete' attachment_id=media_item.id %}" class="inline-form media-delete-form">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}#reviews">
                        <button class="btn btn-ghost" type="submit">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if user.is_authenticated and item.is_mine %}
            <form method="post" action="{% url 'media:upload' %}" enctype="multipart/form-data" class="media-form-inline">
                {% csrf_token %}
                <input type="hidden" name="target_type" value="review">
                <input type="hidden" name="target_id" value="{{ item.id }}">
                <input type="hidden" name="next" value="{{ request.get_full_path }}#reviews">
                <label for="review-media-trip-{{ item.id }}">Attach media to this review</label>
                <input id="review-media-trip-{{ item.id }}" class="form-input" type="file" name="file" accept="image/*,video/*" required>
                <input class="form-input" type="text" name="caption" maxlength="280" placeholder="Optional caption">
                <button class="btn btn-ghost" type="submit">Attach media</button>
            </form>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No reviews yet. Be the first to share your experience.</p>
    {% endif %}
</section>
{% endblock %}
